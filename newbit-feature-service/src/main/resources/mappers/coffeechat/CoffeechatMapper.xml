<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newbit.newbitfeatureservice.coffeechat.query.mapper.CoffeechatMapper">
    <select id="selectCoffeechatById" resultType="CoffeechatDto">
        SELECT
        c.coffeechat_id,
        c.progress_status,
        c.request_message,
        c.purchase_quantity,
        c.confirmed_schedule,
        c.ended_at,
        c.mentor_id,
        c.mentee_id,
        c.updated_at, <!--삭제 일시( progress status를 cancel로 변경한 일시가 가장 마지막으로 기록 )-->
        r.reason
        FROM coffeechat c
        JOIN cancel_reason r ON (c.cancel_reason_id = r.cancel_reason_id)
        WHERE coffeechat_id = #{ coffeechatId }
    </select>
    <select id="selectCoffeechats" resultType="CoffeechatListDto">
        SELECT
        c.coffeechat_id,
        c.progress_status,
        c.request_message,
        u.profile_image_url,
        u.nickname
        FROM coffeechat c
        <choose>
            <when test="authority == 'USER'">
                JOIN mentor m ON (c.mentor_id = m.mentor_id)
                JOIN user u ON (u.user_id = m.user_id)
            </when>
            <when test="authority == 'MENTOR'">
                JOIN mentor m ON (c.mentor_id = m.mentor_id)
                JOIN user u ON (u.user_id = c.mentee_id)
            </when>
        </choose>
        <where>
            <choose>
                <when test="authority == 'MENTOR' and userId != null">
                    AND m.user_id = #{userId}
                </when>
                <when test="authority == 'USER' and userId != null">
                    AND c.mentee_id = #{userId}
                </when>
            </choose>
            <if test="isProgressing != null">
                AND c.progress_status NOT IN ('COMPLETE', 'CANCEL')
            </if>
            <if test="progressStatus != null">
                AND c.progress_status = #{ progressStatus }
            </if>
        </where>
        ORDER BY c.coffeechat_id DESC
        LIMIT #{ limit } OFFSET #{ offset }
    </select>
    <select id="countCoffeechats" resultType="long">
        SELECT COUNT(*)
        FROM coffeechat c
        <choose>
            <when test="authority == 'MENTOR'">
                JOIN mentor m ON c.mentor_id = m.mentor_id
            </when>
        </choose>
        <where>
            <choose>
                <when test="authority == 'MENTOR' and userId != null">
                    AND m.user_id = #{userId}
                </when>
                <when test="authority == 'USER' and userId != null">
                    AND c.mentee_id = #{userId}
                </when>
            </choose>
            <if test="isProgressing != null">
                AND c.progress_status NOT IN ('COMPLETE', 'CANCEL')
            </if>
            <if test="progressStatus != null">
                AND c.progress_status = #{ progressStatus }
            </if>
        </where>
    </select>
    <select id="selectRequestTimeByCoffeechatId" resultType="RequestTimeDto">
        SELECT
        r.request_time_id,
        r.event_date,
        r.start_time,
        r.end_time,
        r.coffeechat_id
        FROM request_time r
        WHERE r.coffeechat_id = #{ coffeechatId }
    </select>
    <select id="selectCoffeechatIdByEndDate" resultType="java.lang.Long">
        SELECT
        c.coffeechat_id
        FROM coffeechat c
        WHERE DATE(ended_at) = #{ targetDate }
    </select>
    <select id="countProgressCoffeechats" resultType="long">
        SELECT COUNT(*)
        FROM coffeechat c
        <where>
            c.progress_status NOT IN ('COMPLETE', 'CANCEL')
            <if test="mentorId != null">
                AND c.mentor_id = #{ mentorId }
            </if>
            <if test="menteeId != null">
                AND c.mentee_id = #{ menteeId }
            </if>
        </where>
    </select>
</mapper>